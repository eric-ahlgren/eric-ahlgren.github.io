<html>
<script src='https://d3js.org/d3.v7.min.js'></script>
<style>
circle {fill: lightblue; stroke: black; opacity: 0.7;}
rect {fill: lightgray;, stroke: black;} 
/*body {color:  black;}*/
.link line {stroke:  black;}
.node circle {stroke: lightsteelblue; fill: lightskyblue;}
.node text {text-anchor: middle; fill: navy; font: 16px sans-serif;}
</style>
<body onload='init()'>
<!-- <body onload='test()'>
 -->
 <div id="svg_template">
 <svg width=300000 height=3000>
</svg>
<!-- <script>
    fetch('data/mean_by_state.csv').then(function(response) { console.log(response);
      return response;
    }).then(function(json) {
      console.log(json);
    }).catch(function(err) {
      console.log('Fetch problem: ' + err.message);
    });
</script> -->
<!-- <script>
    async function test() {
        data = await d3.text('data/mean_by_state.csv').then(function(data) { return data; });
        console.log(data)
    }
</script> -->
<script>
async function init() {
//var data = [4,8,15,16,23,42];
data = await d3.csv("https://raw.githubusercontent.com/eric-ahlgren/eric-ahlgren.github.io/master/data/mean_by_state.csv");
links = await d3.csv("https://raw.githubusercontent.com/eric-ahlgren/eric-ahlgren.github.io/master/data/state_links.csv");
zip_data = await d3.csv("https://raw.githubusercontent.com/eric-ahlgren/eric-ahlgren.github.io/master/data/mean_by_zip.csv");
time_data = await d3.csv("https://media.githubusercontent.com/media/eric-ahlgren/eric-ahlgren.github.io/master/data/median_housing_1996_2021.csv");
// data = await d3.csv("data/mean_by_state.csv");
// links = await d3.csv("data/state_links.csv");


var margin = 100;
var width = 1000;
var height = 1200;
// var num_zip_codes = data.map(function(d) { return +d.num_zip_codes; });
// var xDomain = num_zip_codes.sort((a, b) => a - b);
// var yMax = d3.max(data, function(d) { return +d.mean_overall; });
// var yMin = d3.min(data, function(d) { return +d.mean_overall; });


// var nStates = d3.map(data, function(d, i) { return i; });
// // console.log(nStates);
// // console.log(links);
// var x = d3.scaleLinear().domain([-1, d3.max(nStates)]).range([0, width]);
// var y = d3.scaleLog().domain([yMin-10000, yMax+200000]).range([height, 0]);
// var reduceFactor = 5000

var svg = d3.select("svg");
// var svg = d3.select("svg"),
//     width = +svg.attr("width"),
//     height = +svg.attr("height");

// var simulation = d3.forceSimulation(data)
//     .force("link", d3.forceLink(links).distance(10)
//         .id(function(d) { return d.State; }))
//     .force("charge", d3.forceManyBody().strength(-10))
//     .force("center", d3.forceCenter(width / 2, height / 2))
//     // .force("x", d3.forceX())
//     // .force("y", d3.forceY());
//     .force("collision", d3.forceCollide().radius(function(d) {return d.mean_overall / reduceFactor; }));

var mouseover = function(event, d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
    }
var mousemove = function(event, d) {
    //console.log(d3.pointer(d, d3.select(this)));
    //console.log(event.pageX, event.pageY)
    tooltip
      .html("25-year mean value: " + d3.format("($,.0f")(d.mean_overall))
      // .style("left", (d3.pointer(d, d3.select(this))[0]) + "px")
      // .style("top", (d3.pointer(d, d3.select(this))[1]) + "px")
      .style("left", event.pageX + "px")
      .style("top", event.pageY + 20 + "px");
    }
var mouseleave = function(event, d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
    }

var zipmouseover = function(event, d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
    }
var zipmousemove = function(event, d) {
    //console.log(d3.pointer(d, d3.select(this)));
    //console.log(event.pageX, event.pageY)
    tooltip
      .html("Zip Code: "+d.zip_code+"<br>25-year mean value: " + d3.format("($,.0f")(d.mean_housing_price))
      // .style("left", (d3.pointer(d, d3.select(this))[0]) + "px")
      // .style("top", (d3.pointer(d, d3.select(this))[1]) + "px")
      .style("left", event.pageX + "px")
      .style("top", event.pageY + 20 + "px");
    }
var zipmouseleave = function(event, d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
    }

var timemouseover = function(event, d) {
    tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
    }
var timemousemove = function(event, d) {
    //console.log(d3.pointer(d, d3.select(this)));
    //console.log(event.pageX, event.pageY)
    tooltip
      .html("Date: "+d.date+"<br>Median Value: " + d3.format("($,.0f")(d.value))
      // .style("left", (d3.pointer(d, d3.select(this))[0]) + "px")
      // .style("top", (d3.pointer(d, d3.select(this))[1]) + "px")
      .style("left", event.pageX + "px")
      .style("top", event.pageY + 20 + "px");
    }
var timemouseleave = function(event, d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "none")
      .style("opacity", 0.8)
    }


function plotTime(event, d) {
    var margin = 50;
    var width = 800;
    var height = 600;
    var zipCode = d.zip_code;
    var timeData = time_data.filter(function(dd) {return d.zip_code == dd.RegionName})[0];
    var dropCols = ['City', 'CountyName', 'Metro', 'RegionID', 'RegionName', 'RegionType', 'SizeRank', 'State', 'StateName'];
    var values = [];
    var entries = Object.entries(timeData);
    console.log(entries);
    entries.forEach(function(item, index, array) {
        if (! dropCols.includes(item[0]) && item[1].length > 0) {
            obj = {};
            obj.date = d3.timeParse("%Y-%m-%d")(item[0]);
            obj.value = item[1];
            values.push(obj);
        }
    });

    console.log(values);
    d3.selectAll("svg > *").remove()
    window.scrollTo(0,0);
    var x = d3.scaleTime()
      .domain(d3.extent(values, function(d) { return d.date; }))
      .range([0, width]);
    var y = d3.scaleLinear()
      .domain([0, d3.max(values, function(d) { return +d.value; })])
      .range([height, 0]);

    svg.append("path")
      .datum(values)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d.date) + margin; })
        .y(function(d) { return y(d.value) + margin; })
        )
    svg.append("g")
      // .attr("transform", "translate(0," + height + ")")
      // .call(d3.axisBottom(x));
        .attr("transform", "translate("+margin+","+(height+margin)+")")
        // .call(d3.axisBottom(x).tickValues(nZips).tickFormat(d3.format("~s")));
        .call(d3.axisBottom(x));

    svg.append("g")
      // .call(d3.axisLeft(y));
        .attr("transform", "translate("+margin+","+margin+")")
        .call(d3.axisLeft(y).tickFormat(d3.format("~s")));
    svg.append("rect")
        .datum(d)
        .attr("x", margin)
        .attr("y", (height+margin+25))
        .attr("width", "80")
        .attr("height", "30")
        .attr("rx", "10")
        .on("click", plotZips);
    svg.append("text")
          // .attr("transform", "translate(0,6)")
          // .attr("text-anchor", "middle")
          .datum(d)
          .attr("x", margin+20)
          .attr("y", height+margin+45)
          .text("Back")
          .on("click", plotZips);
}

function plotZips(event, d) {
    console.log(event, d);
    window.scrollTo(0,0);
    var margin = 100;
    var width = 1000;
    var height = 1200;
    tooltip
      .style("opacity", 0)
    // var filterStates = function(d) {
    // if (d.State === "AK") { return d; }
    // }
    stateData = zip_data.filter(function(dd) { return d.State === dd.State });
    var nZips = d3.map(stateData, function(d, i) { return i; });

// console.log(nStates);
// console.log(links);
    var yMax = d3.max(stateData, function(d) { return +d.mean_housing_price; });
    var yMin = d3.min(stateData, function(d) { return +d.mean_housing_price; });
    //var x = d3.scaleLinear().domain([-1, d3.max(nZips)]).range([0, width]);
    var x = d3.scaleLinear().domain([-1, d3.max(nZips)]).range([0, d3.max(nZips)*20]);
    var y = d3.scaleLog().domain([yMin-10000, yMax+600000]).range([height, 0]);
    //d3.selectAll("g > *").remove()
    d3.selectAll("svg > *").remove()
    svg.append("g")
     .attr("transform", "translate("+margin+","+margin+")")
     .selectAll(".dot")
    .data(stateData)
    .enter()
    .append("circle")
        .attr("cx", function(d, i) {return x(i);})
        .attr("cy", function(d) {return y(d.mean_housing_price);})
        .attr("r", function(d) {return d.mean_housing_price / 25000; })
        .on("click", plotTime)
        .on("mouseover", zipmouseover)
        .on("mousemove", zipmousemove)
        .on("mouseleave", zipmouseleave);

    svg.append("g")
        .attr("transform", "translate("+margin+","+margin+")")
        .call(d3.axisLeft(y).tickFormat(d3.format("~s")));

    svg.append("g")
        .attr("transform", "translate("+margin+","+(height+margin)+")")
        // .call(d3.axisBottom(x).tickValues(nZips).tickFormat(d3.format("~s")));
        .call(d3.axisBottom(x).tickValues("").tickFormat(d3.format("~s")));
    svg.append("rect")
        .attr("x", margin)
        .attr("y", (height+margin+10))
        .attr("width", "80")
        .attr("height", "30")
        .attr("rx", "10")
        .on("click", plotStates);
    svg.append("text")
          // .attr("transform", "translate(0,6)")
          // .attr("text-anchor", "middle")
          .attr("x", margin+20)
          .attr("y", height+margin+30)
          .text("Back")
          .on("click", plotStates);
    }

var tooltip = d3.select("div")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("position", "absolute")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px");

var plotStates = function(event, d) {
    window.scrollTo(0,0);
    var margin = 100;
    var width = 1000;
    var height = 1200;
    d3.selectAll("svg > *").remove();


    var num_zip_codes = data.map(function(d) { return +d.num_zip_codes; });
    var xDomain = num_zip_codes.sort((a, b) => a - b);
    var yMax = d3.max(data, function(d) { return +d.mean_overall; });
    var yMin = d3.min(data, function(d) { return +d.mean_overall; });


    var nStates = d3.map(data, function(d, i) { return i; });
    // console.log(nStates);
    // console.log(links);
    var x = d3.scaleLinear().domain([-1, d3.max(nStates)]).range([0, width]);
    var y = d3.scaleLog().domain([yMin-10000, yMax+200000]).range([height, 0]);
    var reduceFactor = 5000

    var svg = d3.select("svg");
    // var svg = d3.select("svg"),
    //     width = +svg.attr("width"),
    //     height = +svg.attr("height");

    var simulation = d3.forceSimulation(data)
        .force("link", d3.forceLink(links).distance(10)
            .id(function(d) { return d.State; }))
        .force("charge", d3.forceManyBody().strength(-10))
        .force("center", d3.forceCenter(width / 2, height / 2))
        // .force("x", d3.forceX())
        // .force("y", d3.forceY());
        .force("collision", d3.forceCollide().radius(function(d) {return d.mean_overall / reduceFactor; }));

    var linksel = svg.append("g")
        .attr("class", "link")
        .selectAll("line").data(links).enter();
        // .append("line")

    var nodesel = svg.selectAll(".node")
        .data(data)
        .enter()
        .append("g")
        .attr("class", "node")
        .on("click", plotZips)
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave);
    ;

    nodesel.append("circle")
        .attr("r", function(d) { return d.mean_overall / reduceFactor; });

    nodesel.append("text")
        .attr("transform", "translate(0,6)")
        // .attr("size", function(d) { return 10; })
        // .attr("color", function(d) { return "#191970"; })
        .text(function(d) { return d.State; });

    // var tooltip = d3.selectAll(".node")
    //     .append("div")



    simulation.on("tick", ticked);

    function ticked() {
        // linksel.attr("x1", function(d) { return d.source.x; })
        //     .attr("y1", function(d) { return d.source.y; })
        //     .attr("x2", function(d) { return d.target.x; })
        //     .attr("y2", function(d) { return d.target.y; });

        nodesel.attr("transform", function(d, i) {
            //return "translate(" + x(i) + "," + y(d.mean_overall) + ")";
            return "translate(" + d.x + "," + d.y + ")";
        });
    }
}
plotStates();

// function ticked() {
//   var u = nodesel
//     .join('circle')
//     .attr('r', 5)
//     .attr('cx', function(d) {
//       return d.x
//     })
//     .attr('cy', function(d) {
//       return d.y
//     });
// }

// svg.append("g")
//      .attr("transform", "translate("+margin+","+margin+")")
//      .selectAll("dot")
//     .data(data)
//     .enter()
//     .append("circle")
//         .attr("cx", function(d, i) {console.log(x(i)); return x(i);})
//         .attr("cy", function(d) {console.log(y(d.mean_overall)); return y(d.mean_overall);})
//         .attr("r", function(d) {return d.mean_overall / 10000; })
//     .append("text")
//         .attr("x", function(d) { return "50%"; })
//         .attr("y", function(d) { return "50%"; })
//         .attr("stroke", function(d) { return "#51c5cf"; })
//         .attr("stroke-width", function(d) { return "2px"; })
//         .attr("dy", function(d) { return ".3em"; })
//         .attr("text-anchor", function(d) { return "middle"; })
//         .attr("font-size", function(d) { return "20px"; })
//         .text(function(d) {return d.State });

// svg.append("g")
//     .attr("transform", "translate("+margin+","+margin+")")
//     .call(d3.axisLeft(y).tickFormat(d3.format("~s")));

// svg.append("g")
//     .attr("transform", "translate("+margin+","+(height+margin)+")")
//     .call(d3.axisBottom(x).tickValues(nStates).tickFormat(d3.format("~s")));


// d3.select("svg")
//     .attr("width",width + 2*margin)
//     .attr("width",height + 2*margin)
//     .append("g")
//     .attr("transform","translate("+margin+","+margin+")")
//     .selectAll("rect")
//     .data(data)
//     .enter()
//     .append("rect")
//     .attr("x", function(d, i) {return x(i);})
//     .attr("y", function(d, i) {return y(d);})
//     .attr("width", x.bandwidth)
//     .attr("height", function(d) {return height - y(d);});

// d3.select("svg").append("g")
//     .attr("transform","translate("+margin+","+margin+")")
//      .call(d3.axisLeft(y));

// d3.select("svg").append("g")
//     .attr("transform","translate("+margin+","+(height+margin)+")")
//     .call(d3.axisBottom(x));
// }

}

</script>
</div>
</body>
</html>
